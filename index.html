<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Widget V62</title>
    <style>
        :root {
            --bg-color: #FFFFFF; --text-color: #37352F; --accent-color: #E3E2E0;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            --base-size: 16px; --radius: 8px; --pad: 1rem;
        }
        @media (prefers-color-scheme: dark) { :root { --bg-color: #191919; --text-color: #D4D4D4; --accent-color: #2F2F2F; } }
        
        body { margin: 0; padding: var(--pad); font-family: var(--font-stack); background: var(--bg-color); color: var(--text-color); font-size: var(--base-size); box-sizing: border-box; }
        
        #dashboard { display: flex; flex-wrap: wrap; gap: 1rem; max-width: 900px; margin: 0 auto; align-items: flex-start; }
        .widget-block { width: 100%; box-sizing: border-box; border: 1px solid transparent; border-radius: var(--radius); }
        .widget-block.half-width { width: calc(50% - 0.5rem); }
        .widget-block.third-width { width: calc(33.333% - 0.67rem); }
        
        .theme-card .widget-block { border-color: var(--accent-color); padding: var(--pad); }
        .theme-minimal .progress-bg { height: 4px; }
        
        .widget-header { font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px; opacity: 0.6; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-color, inherit); }
        
        /* GRID 3.0 */
        .grid-container { display: flex; flex-wrap: wrap; gap: 2px; margin-top: 5px; }
        .grid-cell { background: var(--block-color, #37352F); border-radius: 1px; flex-shrink: 0; opacity: 0.2; } 
        .grid-cell.filled { opacity: 1; }
        .grid-subline { font-size:0.6em; opacity:0.5; margin-bottom:2px; color: var(--text-color, inherit); }
        
        .break { flex-basis: 100%; height: 0; }
        
        /* COMPONENTS */
        .progress-wrapper { margin-bottom: 0.5rem; }
        .progress-meta { display: flex; justify-content: space-between; font-size: 0.85em; margin-bottom: 2px; color: var(--text-color, inherit); }
        
        .progress-bg { height: 8px; background: rgba(128,128,128, 0.2); border-radius: 4px; overflow: hidden; } 
        .progress-fill { height: 100%; width: 0%; transition: width 0.5s ease-in-out; background-color: var(--block-color, #37352F); } 
        
        .clock-row { display: flex; justify-content: space-between; border-bottom: 1px solid var(--block-color, #37352F); padding: 4px 0; }
        .clock-row:last-child { border: none; }
        .clock-left { display: flex; flex-direction: column; }
        .clock-city { font-weight: 600; font-size: 0.95em; color: var(--text-color, inherit); }
        .clock-date { font-size: 0.75em; opacity: 0.6; color: var(--text-color, inherit); }
        .clock-time { font-family: monospace; font-weight: bold; font-size: 1.1em; color: var(--text-color, inherit); }
        
        .date-display { font-size: 1.5em; font-weight: 700; color: var(--text-color, inherit); line-height: 1.2; }
        .date-sub { font-size: 0.9em; opacity: 0.6; margin-top: 4px; font-weight: 500; color: var(--text-color, inherit); }
        
        .moon-display { display: flex; align-items: center; gap: 15px; }
        .moon-icon { font-size: 2.5em; line-height: 1; color: var(--block-color, #37352F); }
        .moon-details { font-size: 0.9em; line-height: 1.4; color: var(--text-color, inherit); }
        
        /* TIMERS & CARDS */
        .timer-bubble { background: var(--block-color, #e0e0e0); color: var(--text-color, #37352F); padding: 15px; border-radius: var(--radius); text-align: center; } 
        .timer-display { font-size: 2.5em; font-weight: 700; font-family: monospace; margin: 10px 0;}
        .timer-btn { background: rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.1); padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.8em; font-weight:600; color:inherit; }
        .timer-btn:hover { background: rgba(0,0,0,0.1); }
        
        .seq-table { width: 100%; font-size: 0.8em; border-collapse: collapse; opacity: 0.8; text-align: left; margin-top:10px; color:inherit; }
        .seq-table td { padding: 2px 0; }
        .seq-table .active-row { font-weight: bold; opacity: 1; }
        
        .counter-wrap { display: flex; align-items: center; justify-content: space-between; background: var(--block-color, #e0e0e0); padding: 5px 10px; border-radius: var(--radius); color: var(--text-color, #37352F); }
        .counter-btn { border: none; background: transparent; cursor: pointer; font-size: 1.2em; color: inherit; }
        .counter-val { font-weight: bold; font-family: monospace; font-size: 1.2em; color: inherit; }
        
        .countdown-line { display: flex; justify-content: space-between; align-items: baseline; font-size: 1.1em; color: var(--text-color, inherit); }
        .countdown-val { font-weight: bold; color: var(--block-color, #37352F); } 
        
        .spacer-line { width: 100%; border-bottom-color: var(--block-color, #37352F); opacity: 0.5; }
        .spacer-dashed { border-bottom-style: dashed; } .spacer-dotted { border-bottom-style: dotted; } .spacer-solid { border-bottom-style: solid; }
        
        /* RESET BUTTON */
        .cycle-reset-btn { 
            background: rgba(255,255,255,0.9); border: 1px solid #ccc; color: #333; font-size: 0.75em; padding: 2px 8px; border-radius: 4px; cursor: pointer; margin-left: 8px; pointer-events: auto; font-weight: bold; z-index: 100; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.2); display: inline-block; 
        }

        /* EDIT BUTTON */
        .edit-btn {
            position: fixed; top: 10px; right: 10px;
            width: 30px; height: 30px;
            background: rgba(255,255,255,0.9); border: 1px solid #ccc;
            border-radius: 50%; text-align: center; line-height: 28px;
            color: #555; text-decoration: none; font-size: 16px;
            opacity: 0.5; transition: opacity 0.3s, transform 0.2s; z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none; 
        }
        body:hover .edit-btn { opacity: 1; }
        .edit-btn:hover { background: #fff; transform: scale(1.1); }
    </style>
</head>
<body>
    <a id="edit-btn" class="edit-btn" href="#" title="Edit Widget">âœŽ</a>

    <div id="dashboard"></div>
    <script>
        // V62: UTF8 DECODER
        function b64_to_utf8(str) { try { return decodeURIComponent(escape(window.atob(str))); } catch(e) { return window.atob(str); } }

        function getConfig() { 
            try { 
                const config = JSON.parse(b64_to_utf8(window.location.hash.substring(1))); 
                if(config.blocks) {
                    config.blocks.forEach((b, i) => {
                        if(!b.id) b.id = 'blk_legacy_' + i; 
                    });
                }
                return config;
            } catch(e) { return null; } 
        }
        
        // V62: EDIT BUTTON LOGIC (Self-Awareness)
        function setupEditLink() {
            if (window.self === window.top) {
                const btn = document.getElementById('edit-btn');
                if(btn) {
                    btn.style.display = 'block';
                    btn.onclick = (e) => {
                        e.preventDefault();
                        let path = window.location.pathname;
                        if(path.endsWith('index.html')) path = path.replace('index.html', 'admin.html');
                        else if(path.endsWith('/')) path += 'admin.html';
                        else path += '/admin.html';
                        window.location.href = path + window.location.hash;
                    };
                }
            }
        }

        const container = document.getElementById('dashboard');

        // --- GLOBAL HELPER ---
        function createBarElement(label, start, end, isCycle, cycleId, daysForCycle, resetMode) {
            let pct = 0;
            let isDone = false;
            let valText = "0.0%";

            if(!isCycle && start && end) { 
                const now = new Date(); 
                if(now > end) pct = 100; else if(now > start) pct = Math.max(0, ((now - start) / (end - start)) * 100); 
                valText = `${pct.toFixed(1)}%`;
            }
            
            if(isCycle && start && daysForCycle) {
                const now = new Date();
                const duration = parseFloat(daysForCycle) * 86400000;
                const elapsed = now - start;
                
                if(elapsed >= duration) {
                    pct = 100;
                    isDone = true;
                    if(resetMode === 'manual') valText = "Done";
                    else valText = "100.0%";
                } else if(elapsed > 0) {
                    pct = (elapsed / duration) * 100;
                    valText = `${pct.toFixed(1)}%`;
                }
                
                if(resetMode === 'auto' && elapsed > 0) {
                    pct = ((elapsed % duration) / duration) * 100;
                    valText = `${pct.toFixed(1)}%`;
                    isDone = false; 
                }
            }

            if(isNaN(pct)) pct = 0;

            const wrapper = document.createElement('div'); wrapper.className = 'progress-wrapper';
            const safeColor = 'var(--block-color, #37352F)';
            
            let resetBtn = '';
            let btnStyle = 'display:none'; 

            if(isCycle) {
                if(resetMode === 'manual') {
                    btnStyle = 'display:inline-block';
                }
                resetBtn = `<button id="reset-btn-${cycleId}" class="cycle-reset-btn" style="${btnStyle}" onclick="window.resetCycle('${cycleId}')">â†»</button>`;
            }

            wrapper.innerHTML = `
                <div class="progress-meta">
                    <span>${label || 'Progress'}</span>
                    <span><span id="pct-${cycleId || Math.random().toString(36).substr(2, 5)}">${valText}</span>${resetBtn}</span>
                </div>
                <div class="progress-bg">
                    <div class="progress-fill" style="width: ${pct}%; background-color:${safeColor}"></div>
                </div>`;
            return wrapper;
        }

        window.resetCycle = (id) => { 
            if(id) {
                localStorage.setItem(`cycle_reset_${id}`, new Date().getTime()); 
                location.reload(); 
            }
        };

        function render() {
            setupEditLink(); 
            const data = getConfig();
            if (!data) return;
            
            const s = data.settings || {};
            document.documentElement.style.setProperty('--font-stack', s.font === 'serif' ? 'Georgia, serif' : s.font === 'mono' ? 'monospace' : '-apple-system, sans-serif');
            document.documentElement.style.setProperty('--radius', s.corners || '8px');
            document.documentElement.style.setProperty('--pad', s.padding === 'compact' ? '0.75rem' : s.padding === 'spacious' ? '1.5rem' : '1rem');
            
            let baseSize = '16px';
            if(s.textSize === 'small') baseSize = '14px';
            if(s.textSize === 'large') baseSize = '18px';
            document.documentElement.style.setProperty('--base-size', baseSize);
            
            document.body.className = `theme-${s.theme}`;

            container.innerHTML = ''; 
            
            data.blocks.forEach((block, index) => {
                const div = document.createElement('div');
                div.className = 'widget-block';
                div.id = `block-${index}`;
                if (block.width === '50') div.classList.add('half-width');
                if (block.width === '33') div.classList.add('third-width');
                
                if (block.color && block.color !== 'default') {
                    const val = block.color.startsWith('#') ? block.color : `var(--c-${block.color})`;
                    div.style.setProperty('--block-color', val);
                } else { div.style.removeProperty('--block-color'); }
                
                if (block.textColor && block.textColor !== 'default') {
                    const tVal = block.textColor.startsWith('#') ? block.textColor : `var(--c-${block.textColor})`;
                    div.style.setProperty('--text-color', tVal);
                } else { div.style.removeProperty('--text-color'); }

                if(block.type === 'header') div.innerHTML = `<div class="widget-header" style="font-size:1.2em; opacity:1;">${block.text}</div>`;
                else if(block.type === 'empty') div.innerHTML = `&nbsp;`;
                else if(block.type === 'spacer') div.innerHTML = `<div class="spacer-line spacer-${block.style||'solid'}" style="margin-top:10px; margin-bottom:10px; border-bottom-width:${block.thickness||'1px'}"></div>`;
                else if(block.type === 'visual_grid') {
                    try { renderGridBlock(block, div, s); } catch(e) { console.error("Grid Error", e); div.innerHTML = "Grid Error"; }
                }
                else if(block.type === 'moon_phase') renderMoonBlock(block, div);
                else if(block.type === 'counter') renderCounterBlock(block, div, block.id);
                else if(block.type === 'sequence') renderSequenceBlock(block, div, block.id);
                else if(block.type === 'progress_group') renderProgress(block, div, s, index);
                else if(block.type === 'progress_custom') {
                    const s = new Date(block.start); const e = new Date(block.end);
                    if(!isNaN(s) && !isNaN(e)) div.appendChild(createBarElement(block.label, s, e, false, `custom-${index}`));
                }
                else if(block.type === 'progress_cycle') { 
                    let anchor = new Date(block.anchor);
                    if (block.resetMode === 'manual') {
                        const restartTs = localStorage.getItem(`cycle_reset_${block.id}`);
                        if(restartTs) anchor = new Date(parseInt(restartTs));
                    }
                    if(isNaN(anchor.getTime())) anchor = new Date();
                    const wrap = createBarElement(block.label, anchor, null, true, block.id, block.days, block.resetMode); 
                    wrap.id=`cycle-wrap-${block.id}`; 
                    div.appendChild(wrap); 
                }
                else if (block.type === 'world_clock') {
                    block.locations.forEach((loc, i) => {
                        const row = document.createElement('div'); row.className = 'clock-row';
                        row.innerHTML = `<div class="clock-left"><span class="clock-city">${loc.label} <span style="font-weight:400;opacity:0.5;font-size:0.9em" id="abbr-${index}-${i}"></span></span><span class="clock-date" id="date-${index}-${i}">--</span></div><span class="clock-time" id="clock-${index}-${i}">--:--</span>`;
                        div.appendChild(row);
                    });
                }
                else if (block.type === 'date_display') { 
                    div.innerHTML = `<div class="date-display" id="date-main-${index}"></div><div class="date-sub" id="date-sub-${index}"></div>`; 
                }
                else if (block.type === 'countdown') { 
                    div.innerHTML = `<div class="countdown-line"><span>${block.label}</span><span class="countdown-val" id="cnt-${index}">--</span></div>`; 
                }
                else if (block.type === 'timer') {
                    const hrs = parseInt(block.hours)||0; const mins = parseInt(block.minutes)||0; const total = (hrs*60)+mins; const label = hrs>0 ? `${hrs}h ${mins}m` : `${mins}m`;
                    div.innerHTML = `<div class="timer-bubble"><div style="font-size:0.8em; opacity:0.8; text-transform:uppercase; letter-spacing:1px;">${block.label||'TIMER'}</div><div class="timer-display" id="timer-display-${block.id}">00:00</div><div class="timer-controls"><button class="timer-btn" onclick="startTimer('${block.id}', ${total})">Start</button><button class="timer-btn" onclick="stopTimer('${block.id}')">Stop</button></div></div>`;
                }
                
                container.appendChild(div);
            });
            updateDynamics(data.blocks, s);
        }

        // --- GRID 3.0 ---
        function renderGridBlock(b, parent, settings) {
            let html = `<div class="widget-header">${b.gridType.toUpperCase()}</div>`;
            const now = new Date();
            let px = b.blockSize==='24px'?24 : b.blockSize==='16px'?16 : 12;
            let wMult = b.shape==='wide'?2 : b.shape==='ultrawide'?3 : 1;
            let w = `${px*wMult}px`; let h = `${px}px`;
            
            const getWeek = (date) => {
                const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                const dayNum = d.getUTCDay() || 7;
                d.setUTCDate(d.getUTCDate() + 4 - dayNum);
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
            };

            if(b.gridType === 'year') { 
                const currentWeek = getWeek(now);
                html += `<div class="grid-subline">Week ${currentWeek} of 52</div><div class="grid-container">`;
                for(let i=1; i<=52; i++) {
                    if((i-1)%13===0 && i>1) html += `<div class="break"></div>`;
                    html += `<div class="grid-cell ${i<=currentWeek?'filled':''}" style="width:${w}; height:${h}"></div>`;
                }
                parent.innerHTML = html + `</div>`; return;
            }
            else if(b.gridType === 'month') {
                const dim = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate(); const day = now.getDate();
                html += `<div class="grid-subline">Day ${day}/${dim}</div><div class="grid-container">`;
                for(let i=1; i<=dim; i++) {
                    if((i-1)%7===0 && i>1) html += `<div class="break"></div>`;
                    html += `<div class="grid-cell ${i<=day?'filled':''}" style="width:${w}; height:${h};"></div>`;
                }
                parent.innerHTML = html + `</div>`; return;
            }
            else if(b.gridType === 'week') {
                const days = settings.weekStart==='monday' ? ['M','T','W','T','F','S','S'] : ['S','M','T','W','T','F','S'];
                const dayIdx = (now.getDay() + (settings.weekStart==='monday'?6:0)) % 7 + 1;
                html += `<div class="grid-container" style="margin-bottom:2px;">`;
                days.forEach(d => html += `<div style="width:${w}; text-align:center; font-size:0.6em; opacity:0.5; color:var(--text-color);">${d}</div>`);
                html += `</div><div class="grid-container">`;
                for(let i=1; i<=7; i++) html += `<div class="grid-cell ${i<=dayIdx?'filled':''}" style="width:${w}; height:${h}"></div>`;
                parent.innerHTML = html + `</div>`; return;
            }
            else if(b.gridType === 'day') {
                const hr = now.getHours();
                html += `<div class="grid-subline">Hour ${hr}/24</div><div class="grid-container">`;
                for(let i=0; i<24; i++) {
                    if(i>0 && i%8===0) html += `<div class="break"></div>`;
                    html += `<div class="grid-cell ${i<hr?'filled':''}" style="width:${w}; height:${h};"></div>`;
                }
                parent.innerHTML = html + `</div>`; return;
            }
            else if(b.gridType === 'life') {
                const dob = new Date(b.dob || '1990-01-01'); const age = now.getFullYear() - dob.getFullYear(); const total = parseInt(b.expectancy||80);
                html += `<div class="grid-subline">Year ${age} of ${total}</div><div class="grid-container">`;
                for(let i=0; i<total; i++) {
                    if(i>0 && i%20===0) html += `<div class="break"></div>`;
                    html += `<div class="grid-cell ${i<age?'filled':''}" style="width:${w}; height:${h}"></div>`;
                }
                parent.innerHTML = html + `</div>`; return;
            }
            parent.innerHTML = html;
        }

        function renderMoonBlock(b, parent) { 
            const now = new Date(); const newMoon = new Date(2000, 0, 6, 18, 14); const cycle = 29.53058867;
            const diffDays = (now - newMoon) / 86400000; const age = diffDays % cycle; 
            let phaseIdx = 0;
            if (age > 28.5 || age < 1) phaseIdx = 0; else if (age < 6.4) phaseIdx = 1; else if (age < 8.4) phaseIdx = 2; else if (age < 13.8) phaseIdx = 3; else if (age < 15.8) phaseIdx = 4; else if (age < 21.1) phaseIdx = 5; else if (age < 23.1) phaseIdx = 6; else phaseIdx = 7;
            if (age > 14.26 && age < 15.26) phaseIdx = 4; 
            const icons = ['ðŸŒ‘','ðŸŒ’','ðŸŒ“','ðŸŒ”','ðŸŒ•','ðŸŒ–','ðŸŒ—','ðŸŒ˜'];
            const names = ['New Moon','Waxing Crescent','First Quarter','Waxing Gibbous','Full Moon','Waning Gibbous','Last Quarter','Waning Crescent'];
            const monthNames = ["Wolf","Snow","Worm","Pink","Flower","Strawberry","Buck","Sturgeon","Harvest","Hunter","Beaver","Cold"];
            let html = `<div class="moon-display"><span class="moon-icon">${icons[phaseIdx]}</span><div class="moon-details"><div style="font-weight:bold">${names[phaseIdx]}</div>`;
            if(phaseIdx===4) html += `<div style="color:var(--block-color, var(--text-color))">${monthNames[now.getMonth()]} Moon</div>`;
            html += `<div style="opacity:0.6">${Math.floor(age)} days old</div></div></div>`;
            parent.innerHTML = html;
        }
        
        window.startTimer = (id, m) => { localStorage.setItem(`notion_timer_${id}`, new Date().getTime() + (m * 60000)); updateTimerDisplay(id); };
        window.stopTimer = (id) => { localStorage.removeItem(`notion_timer_${id}`); updateTimerDisplay(id); };
        function updateTimerDisplay(id) { 
            const el = document.getElementById(`timer-display-${id}`); const end = localStorage.getItem(`notion_timer_${id}`);
            if (!end) { if(el) el.innerText = "00:00"; return; }
            const dist = end - new Date().getTime();
            if (dist < 0) { if(el) el.innerText = "Done!"; localStorage.removeItem(`notion_timer_${id}`); return; }
            const m = Math.floor(dist / 60000); const s = Math.floor((dist % 60000) / 1000);
            if(el) el.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        window.addEventListener('hashchange', render);
        render(); setInterval(() => updateDynamics(getConfig().blocks, getConfig().settings), 1000);
    </script>
</body>
</html>
