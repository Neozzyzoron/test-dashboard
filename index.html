<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Widget V24</title>
    <style>
        :root {
            --bg-color: #FFFFFF; --text-color: #37352F; --accent-color: #E3E2E0;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            --base-size: 16px; --radius: 8px; --pad: 1rem;
        }
        @media (prefers-color-scheme: dark) { :root { --bg-color: #191919; --text-color: #D4D4D4; --accent-color: #2F2F2F; } }
        
        body { margin: 0; padding: var(--pad); font-family: var(--font-stack); background: var(--bg-color); color: var(--text-color); font-size: var(--base-size); box-sizing: border-box; }
        
        /* LAYOUT */
        #dashboard { display: flex; flex-wrap: wrap; gap: 1rem; max-width: 900px; margin: 0 auto; align-items: flex-start; }
        .widget-block { width: 100%; box-sizing: border-box; border: 1px solid transparent; border-radius: var(--radius); }
        .widget-block.half-width { width: calc(50% - 0.5rem); }
        .widget-block.third-width { width: calc(33.333% - 0.67rem); }
        
        /* THEMES */
        .theme-card .widget-block { border-color: var(--accent-color); padding: var(--pad); }
        .theme-minimal .progress-bg { height: 4px; }
        .widget-header { font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px; opacity: 0.6; margin-bottom: 0.5rem; font-weight: 600; color: var(--block-color, inherit); }
        
        /* COMPONENTS */
        .clock-row { display: flex; justify-content: space-between; border-bottom: 1px solid var(--accent-color); padding: 4px 0; }
        .clock-row:last-child { border: none; }
        .clock-left { display: flex; flex-direction: column; }
        .clock-city { font-weight: 600; font-size: 0.95em; }
        .clock-date { font-size: 0.75em; opacity: 0.6; }
        .clock-time { font-family: monospace; font-weight: bold; font-size: 1.1em; color: var(--block-color, inherit); }

        .progress-wrapper { margin-bottom: 0.5rem; }
        .progress-meta { display: flex; justify-content: space-between; font-size: 0.85em; margin-bottom: 2px; }
        .progress-bg { height: 8px; background: var(--accent-color); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--block-color, var(--text-color)); width: 0%; }
        
        /* DATE DISPLAY */
        .date-display { font-size: 1.5em; font-weight: 700; color: var(--block-color, inherit); line-height: 1.2; }
        .date-sub { font-size: 0.9em; opacity: 0.6; margin-top: 4px; font-weight: 500; }

        /* GRID 3.0 */
        .grid-container { display: flex; flex-wrap: wrap; gap: 2px; margin-top: 5px; }
        .grid-cell { background: var(--accent-color); border-radius: 1px; }
        .grid-cell.filled { background: var(--block-color, var(--text-color)); }
        .grid-header-row { display: flex; gap: 2px; margin-bottom: 2px; width: 100%; }
        .grid-header-cell { font-size: 0.6em; text-align: center; color: var(--text-color); opacity: 0.5; }
        
        /* MOON */
        .moon-display { display: flex; align-items: center; gap: 15px; }
        .moon-icon { font-size: 2.5em; line-height: 1; }
        .moon-details { font-size: 0.9em; line-height: 1.4; }
        
        /* SEQUENCE & TIMER (BUBBLE STYLE) */
        .timer-bubble { background: var(--block-color, var(--accent-color)); color: var(--bg-color); padding: 15px; border-radius: var(--radius); text-align: center; }
        .timer-display { font-size: 2.5em; font-weight: 700; font-family: monospace; margin: 10px 0;}
        .seq-next { font-size: 0.9em; opacity: 0.8; margin-bottom:10px;}
        .seq-list { margin-top: 15px; text-align: left; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 4px; }
        .seq-item { display: flex; justify-content: space-between; font-size: 0.8em; padding: 3px 0; opacity: 0.6; }
        .seq-item.active { opacity: 1; font-weight: bold; }
        .timer-controls { display: flex; gap: 10px; justify-content: center; margin-top:10px;}
        .timer-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.8em; font-weight:600; color:inherit; }
        .timer-btn:hover { background: rgba(255,255,255,0.3); }
        
        /* COUNTER */
        .counter-wrap { display: flex; align-items: center; justify-content: space-between; background: var(--accent-color); padding: 5px 10px; border-radius: var(--radius); }
        .counter-btn { border: none; background: transparent; cursor: pointer; font-size: 1.2em; color: var(--text-color); }
        .counter-val { font-weight: bold; font-family: monospace; font-size: 1.2em; color: var(--block-color, inherit); }
        
        /* SPACER */
        .spacer-line { width: 100%; border-bottom-color: var(--accent-color); opacity: 0.5; }
        .spacer-dashed { border-bottom-style: dashed; } .spacer-dotted { border-bottom-style: dotted; } .spacer-solid { border-bottom-style: solid; }
        
        /* COUNTDOWN */
        .countdown-line { display: flex; justify-content: space-between; align-items: baseline; font-size: 1.1em; }
        .countdown-val { font-weight: bold; color: var(--block-color, inherit); }
        
        /* CYCLE */
        .cycle-reset-btn { background:var(--accent-color); border:none; color:var(--text-color); font-size:0.7em; padding:2px 8px; border-radius:4px; cursor:pointer; margin-left:8px; pointer-events:auto; font-weight:bold;}
    </style>
</head>
<body>
    <div id="dashboard"></div>
    <script>
        function getConfig() { try { return JSON.parse(atob(window.location.hash.substring(1))); } catch(e) { return null; } }
        const container = document.getElementById('dashboard');

        function render() {
            const data = getConfig();
            if (!data) return;
            
            const s = data.settings || {};
            document.documentElement.style.setProperty('--font-stack', s.font === 'serif' ? 'Georgia, serif' : s.font === 'mono' ? 'monospace' : '-apple-system, sans-serif');
            document.documentElement.style.setProperty('--radius', s.corners || '8px');
            document.documentElement.style.setProperty('--pad', s.padding === 'compact' ? '0.75rem' : s.padding === 'spacious' ? '1.5rem' : '1rem');
            
            let baseSize = '16px';
            if(s.textSize === 'small') baseSize = '14px';
            if(s.textSize === 'large') baseSize = '18px';
            document.documentElement.style.setProperty('--base-size', baseSize);
            
            document.body.className = `theme-${s.theme}`;

            container.innerHTML = ''; 
            data.blocks.forEach((block, index) => {
                const div = document.createElement('div');
                div.className = 'widget-block';
                div.id = `block-${index}`;
                if (block.width === '50') div.classList.add('half-width');
                if (block.width === '33') div.classList.add('third-width');
                
                // COLOR LOGIC 2.0 (Last Wins)
                // 1. Set Accent (Affects everything by default)
                if (block.color && block.color !== 'default') {
                    const val = block.color.startsWith('#') ? block.color : `var(--c-${block.color})`;
                    div.style.setProperty('--block-color', val);
                    // Also set text color to accent initially
                    div.style.color = val; 
                }
                // 2. Set Text Color (Overrides ONLY text if set)
                if (block.textColor && block.textColor !== 'default') {
                    const tVal = block.textColor.startsWith('#') ? block.textColor : `var(--c-${block.textColor})`;
                    div.style.color = tVal;
                } else if (!block.color || block.color === 'default') {
                    // Reset to theme default if no colors set
                    div.style.color = 'var(--text-color)';
                }

                // Renderers
                if(block.type === 'header') div.innerHTML = `<div class="widget-header" style="font-size:1.2em; opacity:1;">${block.text}</div>`;
                else if(block.type === 'empty') div.innerHTML = `&nbsp;`;
                else if(block.type === 'spacer') div.innerHTML = `<div class="spacer-line spacer-${block.style||'solid'}" style="margin-top:${(block.height||20)/2}px; margin-bottom:${(block.height||20)/2}px; border-bottom-width:${block.thickness||'1px'}"></div>`;
                else if(block.type === 'visual_grid') renderGridBlock(block, div, s);
                else if(block.type === 'moon_phase') renderMoonBlock(block, div);
                else if(block.type === 'counter') renderCounterBlock(block, div, index);
                else if(block.type === 'sequence') renderSequenceBlock(block, div, index);
                else if(block.type === 'progress_group') renderProgress(block, div, s);
                else if(block.type === 'progress_custom') div.appendChild(createBarElement(block.label, new Date(block.start), new Date(block.end), false));
                else if(block.type === 'progress_cycle') { const wrap = createBarElement(block.label, null, null, true, `block-${index}`); div.appendChild(wrap); }
                
                else if (block.type === 'world_clock') {
                    block.locations.forEach((loc, i) => {
                        const row = document.createElement('div'); row.className = 'clock-row';
                        row.innerHTML = `<div class="clock-left"><span class="clock-city">${loc.label} <span style="font-weight:400;opacity:0.5;font-size:0.9em" id="abbr-${index}-${i}"></span></span><span class="clock-date" id="date-${index}-${i}">--</span></div><span class="clock-time" id="clock-${index}-${i}">--:--</span>`;
                        div.appendChild(row);
                    });
                }
                else if (block.type === 'date_display') { 
                    div.innerHTML = `<div class="date-display" id="date-main-${index}"></div><div class="date-sub" id="date-sub-${index}"></div>`; 
                }
                else if (block.type === 'countdown') { 
                    div.innerHTML = `<div class="countdown-line"><span>${block.label}</span><span class="countdown-val" id="cnt-${index}">--</span></div>`; 
                }
                else if (block.type === 'timer') {
                    const hrs = parseInt(block.hours)||0; const mins = parseInt(block.minutes)||0; const total = (hrs*60)+mins;
                    div.innerHTML = `<div class="timer-bubble"><div style="font-size:0.8em; opacity:0.8; text-transform:uppercase; letter-spacing:1px;">${block.label||'TIMER'}</div><div class="timer-display" id="timer-display-${index}">00:00</div><div class="timer-controls"><button class="timer-btn" onclick="startTimer(${index}, ${total})">Start</button><button class="timer-btn" onclick="stopTimer(${index})">Stop</button></div></div>`;
                }
                
                container.appendChild(div);
            });
            updateDynamics(data.blocks, s);
        }

        // --- GRID 3.0 ---
        function renderGridBlock(b, parent, settings) {
            let html = `<div class="widget-header">${b.gridType.toUpperCase()}</div><div class="grid-container">`;
            const now = new Date();
            
            // Width/Height logic
            let px = b.blockSize==='24px'?24 : b.blockSize==='16px'?16 : 12;
            let wMult = b.shape==='wide'?2 : b.shape==='ultrawide'?3 : 1;
            let w = `${px*wMult}px`; let h = `${px}px`;
            
            if(b.gridType === 'year') { 
                const currentWeek = getWeekNumber(now);
                html = `<div class="widget-header">YEAR <span style="font-weight:400; opacity:0.6; margin-left:5px;">Week ${currentWeek} of 52</span></div><div style="display:flex; flex-direction:column; gap:2px;">`;
                for(let r=0; r<4; r++) {
                    html += `<div style="display:flex; gap:2px;">`;
                    for(let c=0; c<13; c++) {
                        const weekNum = r*13 + c + 1;
                        html += `<div class="grid-cell ${weekNum<=currentWeek?'filled':''}" style="width:${w}; height:${h}"></div>`;
                    }
                    html += `</div>`;
                }
                parent.innerHTML = html + `</div>`; return;
            }
            else if(b.gridType === 'week') {
                const days = settings.weekStart==='monday' ? ['M','T','W','T','F','S','S'] : ['S','M','T','W','T','F','S'];
                const dayIdx = (now.getDay() + (settings.weekStart==='monday'?6:0)) % 7 + 1;
                html = `<div class="widget-header">WEEK</div><div style="display:flex; gap:2px; margin-bottom:2px;">`;
                days.forEach(d => html += `<div style="width:${w}; text-align:center; font-size:0.6em; opacity:0.5;">${d}</div>`);
                html += `</div><div style="display:flex; gap:2px;">`;
                for(let i=1; i<=7; i++) html += `<div class="grid-cell ${i<=dayIdx?'filled':''}" style="width:${w}; height:${h}"></div>`;
                parent.innerHTML = html + `</div>`; return;
            }
            // ... (Other Grids similar structure, forcing pixel sizes)
            else if(b.gridType === 'day') {
                const hr = now.getHours();
                html = `<div class="widget-header">DAY <span style="font-weight:400; opacity:0.6;">${hr}/24</span></div><div style="display:flex; flex-direction:column; gap:2px;">`;
                for(let r=0; r<3; r++) {
                    html += `<div style="display:flex; gap:2px;">`;
                    for(let c=0; c<8; c++) { const hIdx = r*8 + c; html += `<div class="grid-cell ${hIdx<hr?'filled':''}" style="width:${w}; height:${h}"></div>`; }
                    html += `</div>`;
                }
                parent.innerHTML = html + `</div>`; return;
            }
            parent.innerHTML = html; 
        }

        // --- SEQUENCE 2.0 + LOOP ---
        function renderSequenceBlock(b, parent, id) {
            let state = JSON.parse(localStorage.getItem(`seq_${id}`) || '{"step":0, "active":false, "endTime":0, "loop":false}');
            const now = Date.now();
            let currentLabel = "Ready", timeLeft = "00:00";
            
            // Loop Toggle Logic
            const toggleLoop = `onclick="toggleSeqLoop(${id})"`;
            const loopState = state.loop ? 'checked' : '';

            if(state.active) {
                const diff = state.endTime - now;
                if(diff <= 0) {
                    state.step++;
                    if(state.step >= b.steps.length) {
                        if(state.loop) {
                            state.step = 0; // Restart
                            state.endTime = now + (b.steps[0].duration * 60000);
                            currentLabel = b.steps[0].label;
                        } else {
                            state.active = false; currentLabel = "Done"; 
                        }
                    } else { 
                        state.endTime = now + (b.steps[state.step].duration * 60000); currentLabel = b.steps[state.step].label; 
                    }
                    localStorage.setItem(`seq_${id}`, JSON.stringify(state));
                } else {
                    currentLabel = b.steps[state.step].label;
                    const m = Math.floor(diff/60000); const s = Math.floor((diff%60000)/1000);
                    timeLeft = `${m}:${s.toString().padStart(2,'0')}`;
                }
            } else {
                if(state.step >= b.steps.length) currentLabel = "Done";
                else { currentLabel = b.steps[state.step] ? b.steps[state.step].label : "Ready"; }
            }

            let html = `<div class="timer-bubble"><div style="font-size:0.8em; opacity:0.8; text-transform:uppercase;">${b.label}</div><div class="timer-display">${timeLeft}</div><div class="seq-next">${currentLabel}</div>`;
            html += `<div class="seq-list">`;
            b.steps.forEach((s, i) => {
                let status = i < state.step ? '✔ ' : i === state.step ? (state.active ? '▶ ' : '● ') : '○ ';
                html += `<div class="seq-item ${i===state.step?'active':''}">${status} ${s.label} (${s.duration}m)</div>`;
            });
            html += `</div>`;
            html += `<div class="timer-controls"><button class="timer-btn" onclick="seqAction(${id}, 'start')">▶</button><button class="timer-btn" onclick="seqAction(${id}, 'pause')">⏸</button><button class="timer-btn" onclick="seqAction(${id}, 'reset')">↻</button></div>`;
            html += `<div style="margin-top:8px; font-size:0.75em;"><label style="cursor:pointer"><input type="checkbox" ${loopState} ${toggleLoop}> Loop Sequence</label></div>`;
            html += `</div>`;
            parent.innerHTML = html;
        }

        window.toggleSeqLoop = (id) => {
            let state = JSON.parse(localStorage.getItem(`seq_${id}`) || '{}');
            state.loop = !state.loop;
            localStorage.setItem(`seq_${id}`, JSON.stringify(state));
        };

        window.seqAction = (id, action) => {
            let state = JSON.parse(localStorage.getItem(`seq_${id}`) || '{"step":0, "active":false}');
            const data = getConfig().blocks[id];
            if(action === 'reset') { state.step = 0; state.active = false; }
            if(action === 'start' && !state.active && state.step < data.steps.length) {
                state.active = true; state.endTime = Date.now() + (data.steps[state.step].duration * 60000);
            }
            if(action === 'pause') { state.active = false; } 
            localStorage.setItem(`seq_${id}`, JSON.stringify(state)); render();
        };

        // ... (Counter, Timer, Progress logic same as V23, ensuring Cycle Fix and Time Zone display)
        function updateDynamics(blocks, settings) {
            const now = new Date(); const use24h = settings.use24h === true;
            blocks.forEach((block, bIdx) => {
                if (block.type === 'world_clock') {
                    block.locations.forEach((loc, lIdx) => {
                        const timeEl = document.getElementById(`clock-${bIdx}-${lIdx}`);
                        const abbrEl = document.getElementById(`abbr-${bIdx}-${lIdx}`);
                        const dateEl = document.getElementById(`date-${bIdx}-${lIdx}`);
                        if(timeEl) {
                            const tz = (loc.timezone && loc.timezone !== 'local') ? loc.timezone : undefined;
                            // Time
                            const tOpts = { hour: use24h?'2-digit':'numeric', minute:'2-digit', hour12: !use24h }; if(tz) tOpts.timeZone = tz;
                            let tStr = now.toLocaleTimeString([], tOpts); if(!use24h) tStr = tStr.replace(' ', '');
                            timeEl.innerText = tStr;
                            // Date
                            const dOpts = { weekday: 'short', month: 'short', day: '2-digit' }; if(tz) dOpts.timeZone = tz;
                            if(dateEl) dateEl.innerText = now.toLocaleDateString([], dOpts);
                            // Offset
                            if(abbrEl && loc.timezone) {
                                try {
                                    const dateInTz = new Date(now.toLocaleString('en-US', { timeZone: loc.timezone }));
                                    const dateInUtc = new Date(now.toLocaleString('en-US', { timeZone: 'UTC' }));
                                    const offset = (dateInTz - dateInUtc) / 3600000;
                                    const sign = offset >= 0 ? '+' : '';
                                    abbrEl.innerText = `(GMT${sign}${offset})`;
                                } catch(e) { abbrEl.innerText = ''; }
                            }
                        }
                    });
                }
                // ... (Rest of logic same as V23)
                if (block.type === 'progress_cycle') {
                    const resetMode = block.resetMode || 'auto';
                    let anchor = new Date(block.anchor);
                    if (resetMode === 'manual') {
                        const restartTs = localStorage.getItem(`cycle_reset_block-${bIdx}`);
                        if(restartTs) anchor = new Date(parseInt(restartTs));
                    }
                    const days = parseFloat(block.days) || 1; 
                    const duration = days * 86400000;
                    const elapsed = now - anchor;
                    let pct = 0; let isDone = false;
                    if(elapsed < 0) pct = 0;
                    else {
                        if (resetMode === 'auto') pct = ((elapsed % duration) / duration) * 100;
                        else { if (elapsed >= duration) { pct = 100; isDone = true; } else { pct = (elapsed / duration) * 100; } }
                    }
                    // Fix manual stop logic
                    const bar = document.querySelector(`#block-${bIdx} .progress-fill`);
                    const txt = document.querySelector(`#block-${bIdx} .progress-meta span:last-child`);
                    if(bar && txt) { 
                        bar.style.width = `${pct}%`; 
                        if(isDone) {
                            txt.innerHTML = `Done <button class="cycle-reset-btn" onclick="resetCycle('block-${bIdx}')">↻</button>`;
                        } else {
                            txt.innerText = `${pct.toFixed(1)}%`; 
                        }
                    }
                }
                if (block.type === 'sequence') { const div = document.getElementById(`block-${bIdx}`); if(div) renderSequenceBlock(block, div, bIdx); }
                if (block.type === 'timer') updateTimerDisplay(bIdx);
            });
        }
        
        window.resetCycle = (id) => {
            localStorage.setItem(`cycle_reset_${id}`, new Date().getTime());
        };
        
        function buildDateString(tokens, now) { /* ... V23 logic ... */ return tokens.map(t => { const type = (typeof t === 'string') ? t : t.type; if(type==='space') return ' '; if(type==='slash') return '/'; /* ... rest ... */ return ''; }).join(''); }
        // ... (Remaining helpers) ...

        window.addEventListener('hashchange', render);
        render(); setInterval(() => updateDynamics(getConfig().blocks, getConfig().settings), 1000);
    </script>
</body>
</html>
